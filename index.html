<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta charset="UTF-8">
        <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.min.js"></script>
        <script src="ngDrag.js"></script>
        <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>
    

        <div ng-app="App" ng-controller="Controller" ng-cloak>
            
            <div class="Band Menu">
                <div class="Center">
                    <div class="Pad">
                        Soundcheck
                    </div>
                </div>
            </div>
            
            <div class="Slideshow" ng-class="{'Backward':!Slides.Forward, 'Initial':Slides.Initial}">
               <div class="Band Slide" ng-class="{'Active':Slides.Slides[0]}">
                   <div class="Center">
                        <div class="Pad">
                            <h3>REAT measurement</h3>
                            <form>
                                <div class="form-group">
                                    <label for="InputEmail">Email address</label>
                                    <input type="email" class="form-control" id="InputEmail" placeholder="name@example.com">
                                </div>
                                <div class="form-group">
                                    <label for="InputName">Name</label>
                                    <input type="text" class="form-control" id="InputName" placeholder="">
                                </div>
                            </form>
                            <div class="btn-group">
                                <button type="button" class="btn btn-primary" ng-click="Slides.Change(1)">Begin <i class="icon-headphones"></i></button>
                            </div>
                        </div>
                   </div>
                </div>
                <div class="Band Slide" ng-class="{'Active':Slides.Slides[1]}">
                   <div class="Center">
                       <div class="Pad">
                           <h3>Begin your test</h3>
                            <p class="lead">Please have your headphones and ear protection ready</p>
                            <p>
                                This will begin a two part test.
                            </p>
                            <p>
                                Each part of the test will have four volume levels, adjusting a volume level will produce a beep. Move each level down to the exact point where you can no longer hear the tone, then proceed to the next part of the test.
                            </p>
                            <div class="btn-group">
                                <button type="button" class="btn btn-secondary" ng-click="Slides.Change(0)"><i class="icon-chevron-left"></i> Go Back</button>
                                <button type="button" class="btn btn-primary" ng-click="Slides.Change(2)">Part One <i class="icon-chevron-right"></i></button>
                            </div>
                       </div>
                   </div>
                </div>
                <div class="Band Slide" ng-class="{'Active':Slides.Slides[2]}">
                   <div class="Center">
                       <div class="Pad">
                           <h3>Part One: Without Ear Protection</h3>
                           <p class="lead">
                               Put on your headphones, but do not wear ear protection.
                            </p>
                           <div class="btn-group">
                                <button type="button" class="btn btn-secondary" ng-click="Slides.Change(1)"><i class="icon-chevron-left"></i> Go Back</button>
                                <button type="button" class="btn btn-danger" ng-click="TestNormal.Reset()" ng-disabled="!TestNormal.PartiallyDone()">Reset <i class="icon-refresh"></i></button>
                                <button type="button" class="btn btn-primary" ng-click="Slides.Change(3)" ng-disabled="!TestNormal.Done()">Continue <i class="icon-chevron-right"></i></button>
                            </div>
                            <div class="TestSet">
                                <div class="Test" ng-repeat="Test in TestNormal.Tests track by $index" ng-class="{'Active':Test.Active, 'Completed':Test.Completed}">
                                    <div class="Cap"><span>{{Test.Clean()}}</span></div>
                                    <div class="Slider Interactive" ng-drag ng-drag-move="Test.HandlerDrag" ng-drag-start="Test.HandlerStart" ng-drag-stop="Test.HandlerStop">
                                        <div class="Bar" style="height:{{Test.DB*100}}%;"></div>
                                    </div>
                                </div>
                            </div>
                       </div>
                   </div>
                </div>
                <div class="Band Slide" ng-class="{'Active':Slides.Slides[3]}">
                   <div class="Center">
                       <div class="Pad">
                           <h2>Continue your test</h2>
                            <p class="lead">Please have your headphones and ear protection ready</p>
                            <p>
                                Put in your ear protection and make sure your headphones are on correctly.
                            </p>
                            <div class="btn-group">
                                <button type="button" class="btn btn-secondary" ng-click="Slides.Change(0)"><i class="icon-chevron-left"></i> Go Back</button>
                                <button type="button" class="btn btn-primary" ng-click="Slides.Change(2)">Part Two <i class="icon-chevron-right"></i></button>
                            </div>
                       </div>
                   </div>
                </div>
                <!--
                <div class="Slide 2" ng-click="Slide = 2">
                    <h2>Low Frequency Test</h2>
                    <p>adjust both sliders until you can no longer hear their tone.</p>
                </div>
                
                <div class="Slide 3" ng-click="Slide = 3">
                    <h2>High Frequency Test</h2>
                    <p>adjust both sliders until you can no longer hear their tone.</p>
                </div>
                
                <div class="Slide">
                    <h2></h2>
                </div> 
                -->
            </div>
            

        </div>

        <script>
            angular
            .module("App", ["ngDrag"])
            .factory("Tone", [function()
            {
                var Tone = {};
                Tone.Context = new (window.AudioContext || window.webkitAudioContext)();
                Tone.Time = {
                    Timer:0,
                    Counter:0,
                    Update: function()
                    {
                        switch(Tone.Time.Counter)
                        {
                            case 0:
                                Tone.GainBeep.gain.value = 1;
                                break;
                            case 1:
                                Tone.GainBeep.gain.value = 0;
                                break;
                            default:
                                Tone.Time.Counter = -1;
                        }
                        Tone.Time.Counter++;
                    },
                    Reset: function()
                    {
                        Tone.GainBeep.gain.value = 0;
                        Tone.Time.Counter = 0;
                    },
                    Start: function()
                    {
                        Tone.Time.Reset();
                        Tone.Time.Timer = setInterval(Tone.Time.Update, 100);
                    },
                    Stop: function()
                    {
                        clearInterval(Tone.Time.Timer);
                        Tone.Time.Reset();
                    }
                };

                Tone.Setup = function(inFrequency, inPan, inDB)
                {
                    Tone.GainBeep = Tone.Context.createGain();
                    Tone.GainBeep.gain.value = 0;
                    Tone.GainDB = Tone.Context.createGain();
                    Tone.Panner = Tone.Context.createStereoPanner();
                    Tone.Oscillator = Tone.Context.createOscillator();
                    Tone.Oscillator.start();

                    Tone.Oscillator.connect(Tone.GainDB);
                    Tone.GainDB.connect(Tone.GainBeep);
                    Tone.GainBeep.connect(Tone.Panner);
                    Tone.Panner.connect(Tone.Context.destination);

                    Tone.Oscillator.frequency.value = inFrequency;
                    Tone.Panner.pan.value = inPan;
                    Tone.Fade(inDB);
                };
                Tone.Fade = function(inDB)
                {
                    Tone.GainDB.gain.value = inDB;
                };
                return Tone;
            }])
            .factory("Test", ["Tone", function(Tone)
            {
                return function(inFrequency, inPan, inDB)
                {
                    var test = {
                        Initial: [inFrequency, inPan, inDB]
                    };
                    test.Reset = function()
                    {
                      test.Frequency = test.Initial[0];  
                      test.Pan = test.Initial[1];  
                      test.DB = test.Initial[2];  
                      test.Active = false;
                      test.Completed = false;
                    };
                    test.HandlerDrag = function(inPos)
                    {
                        test.DB = 1 - (Math.ceil(inPos.y*10))/10;
                        Tone.Fade(test.DB);
                    };
                    test.HandlerStart = function()
                    {
                        test.Completed = true;
                        Tone.Setup(test.Frequency, test.Pan, test.DB);
                        Tone.Time.Start();
                        test.Active = true;
                    };
                    test.HandlerStop = function()
                    {
                        Tone.Time.Stop();
                        test.Active = false;
                    };
                    test.Clean = function()
                    {
                        return Math.floor(test.DB*100)/100;  
                    };
                    test.Reset();
                    return test;
                };
            }])
            .factory("TestSet", ["Test", function(Test)
            {
                return function()
                {
                    var obj = {};
                    
                    obj.HighLeft = Test(4000, 1, 0.8);
                    obj.HighRight = Test(4000, -1, 0.8);
                    obj.LowLeft = Test(250, 1, 0.8);
                    obj.LowLRight = Test(250, -1, 0.8);
                    
                    obj.Tests = [];
                    obj.Tests.push(obj.HighLeft);
                    obj.Tests.push(obj.HighRight);
                    obj.Tests.push(obj.LowLeft);
                    obj.Tests.push(obj.LowRight);
                    
                    obj.Reset = function()
                    {
                        var i;
                        for(i=0; i<obj.Tests.length; i++)
                        {
                            obj.Tests[i].Reset();
                        }   
                    };
                    
                    obj.PartiallyDone = function()
                    {
                        var i;
                        for(i=0; i<obj.Tests.length; i++)
                        {
                            if(obj.Tests[i].Completed)
                            {
                                return true;
                            }
                        }
                        return false;
                    }
                    obj.Done = function()
                    {
                        var i;
                        for(i=0; i<obj.Tests.length; i++)
                        {
                            if(!obj.Tests[i].Completed)
                            {
                                console.log("not done");
                                return false;
                            }
                        }
                        console.log("done");
                        return true;
                    };
                    return obj;
                };
            }])
            .factory("Slideshow", [function()
            {
                return function(inMembers)
                {
                    var obj = {};
                    obj.Index = 0;
                    obj.Slides = inMembers;
                    obj.Forward = true;
                    obj.Initial = true;
                    obj.Change = function(inIndex)
                    {
                        if(inIndex == obj.Index)
                        {
                            return;
                        }
                        obj.Initial = false;
                        obj.Slides[obj.Index] = false;
                        obj.Forward = (inIndex > obj.Index);
                        obj.Index = inIndex;
                        obj.Slides[obj.Index] = true;
                    };
                    return obj;
                }
            }])
            .controller("Controller", ["$scope", "TestSet", "Slideshow", function($scope, TestSet, Slideshow)
            {
                $scope.Slides = Slideshow([true, false, false, false]);
                
                $scope.TestNormal = TestSet();
                $scope.TestProtected = TestSet();
            }]);
        </script>
    </body>
</html>
