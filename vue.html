<!DOCTYPE html>
<html>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
        <link rel="stylesheet" type="text/css" href="styles.css">
    </head>
    <body>
        <div id="App">
            <div v-on:drag="HandlerSlide" v-slider="Value" style="width:300px; height:300px; background:#FA0; margin:5px;">
                <div style="height:100%; background:#F00;" v-bind:style="{width:Rect.x*100 + '%'}"></div>
            </div>
        </div>
        <!-- lerp -->
        <script>
            var Lerp = {
                Get: function(inMin, inAmount, inMax)
                {
                    return (inAmount - inMin)/(inMax - inMin);
                },
                Set: function(inMin, inAmount, inMax)
                {
                    return inMin + inAmount*(inMax - inMin);
                },
                Clip: function(inMin, inAmount, inMax)
                {
                    if(inAmount < inMin)
                    {
                        return inMin;
                    }
                    if(inAmount > inMax)
                    {
                        return inMax;
                    }
                    return inAmount;
                }
            }
        </script>
        
        <!-- slider directive -->
        <script>
            Vue.directive('slider', {
                bind: function(inElement, inBinding, inNode)
                {
                    console.log(inElement);
                    console.log(inBinding);
                    
                    inBinding.value = 5;
                    
                    function handlerMove($event)
                    {
                        //coords of AABB within browser window
                        var rect = inElement.getBoundingClientRect();
                        var locX = $event.clientX || $event.touches[0].clientX;
                        var locY = $event.clientX || $event.touches[0].clientY;
        
                        //$event.client is the coords of the mouse within the browser window
                        var mouseRect = {
                            x:Lerp.Clip(0, locX - rect.left, rect.width),
                            y:Lerp.Clip(0, locY - rect.top, rect.height)
                        };

                        var event = new Event('drag');
                        event.drag = {
                            x: mouseRect.x/rect.width,
                            y: mouseRect.y/rect.height
                        };
                        inElement.dispatchEvent(event);
                    };
            
                    function handlerDown($event)
                    {
                        $event.preventDefault();
                        document.addEventListener("mousemove", handlerMove);
                        document.addEventListener("mouseup", handlerUp);
            
                        document.addEventListener("touchmove", handlerMove);
                        document.addEventListener("touchend", handlerUp);
            
                        handlerMove($event);
                        
                        inElement.dispatchEvent(new Event('dragstart'));
                    };
            
                    function handlerUp($event)
                    {
                        document.removeEventListener("mousemove", handlerMove);
                        document.removeEventListener("mouseup", handlerUp);
            
                        document.removeEventListener("touchmove", handlerMove);
                        document.removeEventListener("touchend", handlerUp);
            
                        inElement.dispatchEvent(new Event('dragstop'));
                    };
                    
                    inElement.addEventListener("mousedown", handlerDown);
                    inElement.addEventListener("touchstart", handlerDown);
                }
            });
        </script>
        
        <!-- tone generator -->
        <script>
            var Tone = {};
            Tone.Context = new (window.AudioContext || window.webkitAudioContext)();
            Tone.Time = {
                Timer:0,
                Counter:0,
                Update: function()
                {
                    switch(Tone.Time.Counter)
                    {
                        case 0:
                            Tone.GainBeep.gain.value = 1;
                            break;
                        case 1:
                            Tone.GainBeep.gain.value = 0;
                            break;
                        default:
                            Tone.Time.Counter = -1;
                    }
                    Tone.Time.Counter++;
                },
                Reset: function()
                {
                    Tone.GainBeep.gain.value = 0;
                    Tone.Time.Counter = 0;
                },
                Start: function()
                {
                    Tone.Time.Reset();
                    Tone.Time.Timer = setInterval(Tone.Time.Update, 100);
                },
                Stop: function()
                {
                    clearInterval(Tone.Time.Timer);
                    Tone.Time.Reset();
                }
            };

            Tone.Setup = function(inFrequency, inPan, inDB)
            {
                Tone.GainBeep = Tone.Context.createGain();
                Tone.GainBeep.gain.value = 0;
                Tone.GainDB = Tone.Context.createGain();
                Tone.Panner = Tone.Context.createStereoPanner();
                Tone.Oscillator = Tone.Context.createOscillator();
                Tone.Oscillator.start();

                Tone.Oscillator.connect(Tone.GainDB);
                Tone.GainDB.connect(Tone.GainBeep);
                Tone.GainBeep.connect(Tone.Panner);
                Tone.Panner.connect(Tone.Context.destination);

                Tone.Oscillator.frequency.value = inFrequency;
                Tone.Panner.pan.value = inPan;
                Tone.Fade(inDB);
            };
            Tone.Fade = function(inDB)
            {
                Tone.GainDB.gain.value = inDB*0.01;
            };
        </script>
       
       <!-- tone/slider component -->
       <script>
            Vue.component('tone', {
                props:['value'],
                mounted: function()
                {
                    var inElement = this.$el;
                    var context = this;
                    
                    console.log(context);
                    
                    function handlerMove($event)
                    {
                        //coords of AABB within browser window
                        var rect = inElement.getBoundingClientRect();
                        var locX = $event.clientX || $event.touches[0].clientX;
                        var locY = $event.clientY || $event.touches[0].clientY;
        
                        //$event.client is the coords of the mouse within the browser window
                        var mouseRect = {
                            x:Lerp.Clip(0, locX - rect.left, rect.width),
                            y:Lerp.Clip(0, locY - rect.top, rect.height)
                        };
            
                        var mouseRelative = {
                            x:mouseRect.x/rect.width,
                            y:mouseRect.y/rect.height
                        };
                        
                        context.$emit('input', mouseRelative);
                    };
            
                    function handlerDown($event)
                    {
                        $event.preventDefault();
                        document.addEventListener("mousemove", handlerMove);
                        document.addEventListener("mouseup", handlerUp);
                        document.addEventListener("touchmove", handlerMove);
                        document.addEventListener("touchend", handlerUp);
            
                        Tone.Setup(250, 0, 100);
                        Tone.Time.Start();
            
                        handlerMove($event);
                    };
            
                    function handlerUp($event)
                    {
                        document.removeEventListener("mousemove", handlerMove);
                        document.removeEventListener("mouseup", handlerUp);
                        document.removeEventListener("touchmove", handlerMove);
                        document.removeEventListener("touchend", handlerUp);
                        
                        Tone.Time.Stop();
                    };
                    
                    inElement.addEventListener("mousedown", handlerDown);
                    inElement.addEventListener("touchstart", handlerDown);
                    
                },
                computed:{
                    style:function()
                    {
                        return {
                            height: (this.value.y*100)+"%",
                            width:"100%",
                            background:"#F00"
                        };
                    }
                },
                template:'<div style="width:500px; height:2000px; background:#FA0;"><div v-bind:style="style"></div></div>'
            });
        </script>
        
        <!-- vue app -->
        <script>
            var App = new Vue({
                el:"#App",
                data:{
                    Value:0.1,
                    Rect:{x:0.5, y:0.5}
                },
                methods:{
                    HandlerSlide: function(inEvent)
                    {
                        this.Rect.x = inEvent.drag.x;
                    }
                }
            });
        </script>
    </body>
</html>