---
---
<!DOCTYPE html>
<html>
    <head>
        
        <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
        
        <!-- Tone -->
        <script>
var Tone;
Tone = {
         Context:false,
      Oscillator:false,
        GainBeep:false,
        GainFade:false,
        GainLeft:false,
       GainRight:false,
    ChannelMerge:false,
    
        Pattern:[0, 1, 0.1, 0, 1, 0.1, 0, 1, 0.1, 0, 0, 0],
       Duration:1,
    KeepBeeping:false,
          Timer:-1
};
Tone.Init = function()
{
    // setup audio context
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    Tone.Context = new AudioContext();

    // create audio nodes
      Tone.Oscillator = Tone.Context.createOscillator();
        Tone.GainBeep = Tone.Context.createGain();
        Tone.GainFade = Tone.Context.createGain();
        Tone.GainLeft = Tone.Context.createGain();
       Tone.GainRight = Tone.Context.createGain();
    Tone.ChannelMerge = Tone.Context.createChannelMerger(2);

    // wire up audio nodes
    Tone.Oscillator.connect(Tone.GainBeep);
      Tone.GainBeep.connect(Tone.GainFade);
      Tone.GainFade.connect(Tone.GainLeft);
      Tone.GainFade.connect(Tone.GainRight);
      Tone.GainLeft.connect(Tone.ChannelMerge, 0, 0);
     Tone.GainRight.connect(Tone.ChannelMerge, 0, 1);
  Tone.ChannelMerge.connect(Tone.Context.destination);

    // start
     Tone.GainBeep.gain.value = 0;
     Tone.GainLeft.gain.value = 0.5;
    Tone.GainRight.gain.value = 0.5;
    Tone.Oscillator.start(Tone.Context.currentTime+0.0);
};
Tone.Start = function()
{
    var i;
    var value, time;

    Tone.KeepBeeping = true;
    Tone.Context.resume();
    Tone.GainBeep.gain.cancelScheduledValues(Tone.Context.currentTime);
    Tone.GainBeep.gain.setValueAtTime(0, Tone.Context.currentTime);

    for(i=0; i<Tone.Pattern.length; i++)
    {
        value = Tone.Pattern[i];
        time =  (i*Tone.Duration/(Tone.Pattern.length-1));
        Tone.GainBeep.gain.linearRampToValueAtTime(value, Tone.Context.currentTime+time);
    }
    Tone.Timer = setTimeout(function()
    {
        if(Tone.KeepBeeping)
        {
            Tone.Start();
        }
    }, Tone.Duration*1000);
};
Tone.Stop = function()
{
    Tone.KeepBeeping = false;
}
Tone.SetFrequency = function(inHz)
{
    Tone.Oscillator.frequency.linearRampToValueAtTime(inHz, Tone.Context.currentTime+0.1);
};
Tone.SetStereo = function(inBias)
{
    var biasVector = [1, 1];
    if(inBias == -1)
    {
        biasVector[1] = 0;
    }
    if(inBias == 1)
    {
        biasVector[0] = 0;
    }
     Tone.GainLeft.gain.linearRampToValueAtTime(biasVector[0], Tone.Context.currentTime+0.1);
    Tone.GainRight.gain.linearRampToValueAtTime(biasVector[1], Tone.Context.currentTime+0.1);
};
Tone.SetVolume = function(inAmount)
{
    Tone.GainFade.gain.linearRampToValueAtTime(inAmount, Tone.Context.currentTime);
}
Tone.Init();
        </script>
        <!-- CustomEvent polyfill -->
        <script>
(function ()
{
    if ( typeof window.CustomEvent === "function" ) return false;
    function CustomEvent ( event, params )
    {
        params = params || { bubbles: false, cancelable: false, detail: undefined };
        var evt = document.createEvent( 'CustomEvent' );
        evt.initCustomEvent( event, params.bubbles, params.cancelable, params.detail );
        return evt;
    }
    CustomEvent.prototype = window.Event.prototype;
    window.CustomEvent = CustomEvent;
})();
        </script>
        
        <!-- Lerp -->
        <script>
        var Lerp = {
            Get: function(inMin, inAmount, inMax)
            {
                return (inAmount - inMin)/(inMax - inMin);
            },
            Set: function(inMin, inAmount, inMax)
            {
                return inMin + inAmount*(inMax - inMin);
            },
            Clip: function(inMin, inAmount, inMax)
            {
                if(inAmount < inMin)
                {
                    return inMin;
                }
                if(inAmount > inMax)
                {
                    return inMax;
                }
                return inAmount;
            }
        };
        </script>
        
        <!-- Drag -->
        <script>
var Drag = {};
Drag.Setup = function(inElement)
{
    var HandlerMove = function(inEvent)
    {
        //coords of AABB within browser window
        var rect = inElement.getBoundingClientRect();
        var locX = inEvent.clientX || inEvent.touches[0].clientX;
        var locY = inEvent.clientY || inEvent.touches[0].clientY;
    
        //inEvent.client is the coords of the mouse within the browser window
        var mouse = {
            x:Lerp.Clip(0, locX - rect.left, rect.width)/rect.width,
            y:Lerp.Clip(0, locY - rect.top, rect.height)/rect.height
        };
        
        var event = new CustomEvent("drag", {bubbles:true, detail:mouse});
        inElement.dispatchEvent( event );
        
        return mouse;
    };
    var HandlerDown = function(inEvent)
    {
        inEvent.preventDefault();
        document.addEventListener("mousemove", HandlerMove);
        document.addEventListener("mouseup", HandlerUp);
        document.addEventListener("touchmove", HandlerMove);
        document.addEventListener("touchend", HandlerUp);
        document.addEventListener("mouseleave", HandlerUp);
    
        var event = new CustomEvent("dragstart", {bubbles:true});
        inElement.dispatchEvent( event );
        HandlerMove(inEvent);
    };
    var HandlerUp = function(inEvent)
    {
        document.removeEventListener("mousemove", HandlerMove);
        document.removeEventListener("mouseup", HandlerUp);
        document.removeEventListener("touchmove", HandlerMove);
        document.removeEventListener("touchend", HandlerUp);
        document.removeEventListener("mouseleave", HandlerUp);
        
        var event = new CustomEvent("dragstop", {bubbles:true});
        inElement.dispatchEvent( event );
    };
    
    inElement.addEventListener("mousedown", HandlerDown);
    inElement.addEventListener("touchstart", HandlerDown);
};
        </script>
        
        <link rel="stylesheet" type="text/css" href="styles.css">
        
    </head>
    <body>
        

        
        <div id="App">
            <button style="width:200px; height:30px;" onclick="Tone.Context.resume()">R E S U M E</button>
            <button style="width:200px; height:30px;" onclick="alert(Tone.Context.state)">t r a c e </button>

            <Slideshow>
                <template slot-scope="Slideshow">
                    
                    <Slide>
                        <h2>REAT Measurement Test</h2>
                        <p>this is new</p>
                        <div class="Controls">
                            <button onclick="Message.Send('button click in child page');">send test</button>
                            <button v-on:click="Slideshow.Next" onclick="Tone.Context.resume()">Start</button>
                        </div>
                    </Slide>
                    
                    <Slide>
                        <h2>Part One</h2>
                        <p>Please remove ear protection and make sure headphones fit correctly</p>
                        <Test-Set v-bind:Test="TestFrequencies" v-on:done="RecordNormal">
                            <div class="Controls" slot-scope="TestSet">
                                <button v-on:click="Slideshow.Previous">Back</button>
                                <button v-on:click="TestSet.Reset" v-show="TestSet.Started">Reset</button>
                                <button v-on:click="Slideshow.Next" v-show="TestSet.Done">Next</button>
                            </div>
                        </Test-Set>
                    </Slide> 
                    
                    <Slide>
                        <h2>Part Two</h2>
                        <p>Please insert ear protection and make sure headphones fit correctly</p>
                        <Test-Set v-bind:Test="TestFrequencies" v-on:done="RecordProtected">
                            <div class="Controls" slot-scope="TestSet">
                                <button v-on:click="Slideshow.Previous">Back</button>
                                <button v-on:click="TestSet.Reset" v-show="TestSet.Started">Reset</button>
                                <button v-on:click="Slideshow.Next" v-show="TestSet.Done">Next</button>
                            </div>
                        </Test-Set>
                    </Slide> 
                    
                    <Slide>
                        <h2>Part Three</h2>
                        <button v-on:click="Finish">Finish</button>
                        <button v-on:click="Slideshow.Change(0, true)">Start Over</button>
                    </Slide>
                    
                </template>
            </Slideshow>
        </div>

        <!-- slide component -->
        <script>
            Vue.component("Slide", {
                data:function()
                {
                    return {
                        CSS:""
                   };
                },
                methods:{
                    Direction:function(inBackward)
                    {
                        if(inBackward)
                        {
                            return "Backward";
                        }
                        else
                        {
                            return "Forward";
                        }
                    },
                    Activate:function(inBackward)
                    {
                        this.CSS = "Active "+this.Direction(inBackward);
                    },
                    Deactivate:function(inBackward)
                    {
                        this.CSS = "Inactive "+this.Direction(inBackward);
                    }
                },
                mounted:function()
                {
                },
               template:"#TemplateSlide"
            });
        </script>
        <script type="x-template" id="TemplateSlide">
            <div class="Band Slide" v-bind:class="CSS">
                <div class="Center">
                    <div class="Pad">
                        <slot></slot>
                    </div>
                </div>
            </div>
        </script>
        
        <!-- slideshow component -->
        <script>
            Vue.component("Slideshow", {
                data: function()
                {
                    return{
                        Children:[],
                        Active:0
                    };
                },
                methods:{
                    Change:function(inIndex, inBackward)
                    {
                        if(inIndex == this.Active){return;}

                        this.Children[this.Active].Deactivate(inBackward);
                        this.Active = inIndex;
                        this.Children[this.Active].Activate(inBackward);
                    },
                    Previous:function()
                    {
                        var index;
                        if(this.Active == 0)
                        {
                            index = this.Children.length-1;
                        }
                        else
                        {
                            index = this.Active-1;
                        }
                        this.Change(index, true);
                    },
                    Next:function()
                    {
                        var index;
                        if(this.Active == this.Children.length-1)
                        {
                            index = 0;
                        }
                        else
                        {
                            index = this.Active+1;
                        }
                        this.Change(index, false);
                    },
                    FindChildren:function()
                    {
                        var i;
                        this.Children = [];
                        for(i=0; i<this.$children.length; i++)
                        {
                            var child = this.$children[i];
                            if(child.$options._componentTag == "slide")
                            {
                                this.Children.push(child);
                            }
                        }
                    }
                },
                mounted: function()
                {
                    this.FindChildren();
                    this.Children[this.Active].Activate(false);
                },
                template:"#TemplateSlideshow"
            })
        </script>
        <script type="x-template" id="TemplateSlideshow">
            <div class="Slideshow">
                <slot v-bind="this">
                </slot>
            </div>
        </script>

        <!-- slider component -->
        <script>
            Vue.directive("Drag", {
                bind:function(inElement)
                {
                    Drag.Setup(inElement);
                }
            })
        </script>
        <script>
            Vue.component("Slider", {
                props:{
                    Steps:{
                        type:Number,
                        default:10
                    },
                    Min:{
                        type:Number,
                        default:0
                    },
                    Max:{
                        type:Number,
                        default:0.8
                    },
                    Hz:{
                        type:Number,
                        default:440
                    },
                    Pan:{
                        Type:Number,
                        default:0
                    }
                },
                data:function()
                {
                    return{
                        Stepped:0,
                        Percent:0,
                        Mapped:0,
                        Adjusted:false,
                        Adjusting:false
                    };
                },
                methods:{
                    HandlerDrag:function(inEvent)
                    {
                      this.Update(1-inEvent.detail.y);
                    },
                    HandlerDragStart:function()
                    {
                        this.Adjusting = true;
                        this.Adjusted = true;

                        Tone.SetFrequency(this.Hz);
                        Tone.SetVolume(this.Mapped);
                        Tone.SetStereo(this.Pan);
                        Tone.Start();
                    },
                    HandlerDragStop:function()
                    {
                        this.Adjusting = false;
                        Tone.Stop();
                        this.$emit("done", this.Mapped);
                    },
                    Recalculate:function(inValue)
                    {
                        this.Stepped = Math.floor(inValue*this.Steps)/this.Steps;
                        this.Percent = this.Stepped*100;
                        this.Mapped = Lerp.Set(this.Min, this.Stepped, this.Max);
                    },
                    Update:function(inValue)
                    {
                        this.Recalculate(inValue);
                        Tone.SetVolume(this.Mapped);
                    },
                    Reset:function()
                    {
                        this.Recalculate(0.8);
                        this.Adjusted = false;
                        this.Adjusting = false;
                    },
                    Collect:function()
                    {
                        return {Hz:this.Hz, Pan:this.Pan, Volume:this.Mapped};
                    }
                },
                mounted:function(){
                    this.Reset();
                },
                template:"#TemplateSlider"
            })
        </script>
        <script type="x-template" id="TemplateSlider">
            <div class="Slider"
                v-bind:class="{Adjusting: Adjusting, Adjusted: Adjusted}"
                v-drag
                v-on:drag="HandlerDrag"
                v-on:dragstart="HandlerDragStart"
                v-on:dragstop="HandlerDragStop">
                <div class="Bar" v-bind:style="{height:Percent+'%'}"></div>
            </div>
        </script>

        <!-- Test set -->
        <script>
            Vue.component("TestSet", {
                props:["Test"],
                data:function()
                {
                    return{
                        Done:false,
                        Started:false,
                        Results:[]
                    };
                },
                methods:{
                    IsDone:function()
                    {
                        var i;
                        var data;
                        for(i=0; i<this.$children.length; i++)
                        {
                            if(!this.$children[i].$data.Adjusted)
                            {
                                return false;
                            }
                        }
                        this.$emit("done", this.Results);
                        return true;
                    },
                    IsStarted:function()
                    {
                        var i;
                        for(i=0; i<this.$children.length; i++)
                        {
                            if(this.$children[i].$data.Adjusted)
                            {
                                return true;
                            }
                        }
                        return false;
                    },
                    Update:function(inKey, inValue)
                    {
                        this.Results[inKey] = inValue
                        this.Done = this.IsDone();
                        this.Started = this.IsStarted();
                    },
                    Reset:function()
                    {
                        var i;
                        for(i=0; i<this.$children.length; i++)
                        {
                            this.$children[i].Reset();
                        }
                        this.Done = false;
                        this.Started = false;
                    }
                },
                mounted:function()
                {
                },
                template:"#TemplateTestSet"
            })
        </script>
        <script type="x-template" id="TemplateTestSet">
            <div class="Test">
                <slot v-bind="this">
                    <button v-on:click="$root.Previous">Back Default</button>
                    <button v-on:click="Reset" v-show="Started">Reset Default</button>
                    <button v-on:click="$root.Next" v-show="Done">Next Default</button>
                </slot>
                <div style="overflow:hidden;">
                    <Slider v-for="(value, key) in Test" v-bind="value" v-on:done="Update(key, $event)"></Slider>
                </div>
            </div>
        </script>

        <!-- vue app -->
        <script>
            var App = new Vue({
                el:"#App",
                data:{
                    TestFrequencies:[
                        {Min:0,   Max:0.08, Steps:20, Hz:4000, Pan:-1},
                        {Min:0,   Max:0.08, Steps:20, Hz:4000, Pan:+1},
                        {Min:0.1, Max:1,    Steps:20, Hz:250,  Pan:-1},
                        {Min:0.1, Max:1,    Steps:20, Hz:250,  Pan:+1}
                    ]
                },
                methods:{
                    RecordNormal:function(inData)
                    {
                        console.log("record normal called", inData);
                        window.parent.postMessage({Event:"RecordNormal", Data:inData}, "*");
                    },
                    RecordProtected:function(inData)
                    {
                        console.log("record protected called", inData);
                        window.parent.postMessage({Event:"RecordProtected", Data:inData}, "*");
                    },
                    Finish:function()
                    {
                        window.parent.postMessage({Event:"Done"}, "*");
                    }
                }
            });
            
            window.onmessage = function(inMessage)
            {
                console.log("Child Message:", inMessage);
                switch(inMessage.data.Event)
                {
                    case "Setup":
                        App.TestFrequencies = inMessage.data.Data; 
                        break;
                }
            };
            document.body.onload = function()
            {
                window.parent.postMessage({Event:"Loaded"}, "*");  
            };
        </script>
    </body>
</html>