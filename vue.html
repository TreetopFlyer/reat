<!DOCTYPE html>
<html>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
        <!-- custom event polyfill -->
        <script>
            (function () {
            
              if ( typeof window.CustomEvent === "function" ) return false;
            
              function CustomEvent ( event, params ) {
                params = params || { bubbles: false, cancelable: false, detail: undefined };
                var evt = document.createEvent( 'CustomEvent' );
                evt.initCustomEvent( event, params.bubbles, params.cancelable, params.detail );
                return evt;
               }
            
              CustomEvent.prototype = window.Event.prototype;
            
              window.CustomEvent = CustomEvent;
            })();
        </script>
        <link rel="stylesheet" type="text/css" href="styles.css">
    </head>
    <body>
        <div id="App">
            <slider v-on:drag="HandlerSlide" v-on:test="HandlerTest" v-bind:value="Rect.x"></slider>
            <tone v-bind:value="0.9"></tone>
            <tone v-bind:value="0.1"></tone>
        </div>
        
        <!-- slider directive -->
        <script>
            Vue.directive('slider', {
                bind: function(inElement, inBinding, inNode)
                {
                    function clip(inMin, inAmount, inMax)
                    {
                        if(inAmount < inMin)
                        {
                            return inMin;
                        }
                        if(inAmount > inMax)
                        {
                            return inMax;
                        }
                        return inAmount;
                    }
                    
                    function handlerMove($event)
                    {
                        //coords of AABB within browser window
                        var rect = inElement.getBoundingClientRect();
                        var locX = $event.clientX || $event.touches[0].clientX;
                        var locY = $event.clientX || $event.touches[0].clientY;
        
                        //$event.client is the coords of the mouse within the browser window
                        var mouseRect = {
                            x:clip(0, locX - rect.left, rect.width),
                            y:clip(0, locY - rect.top, rect.height)
                        };

                        inElement.dispatchEvent(new CustomEvent("drag", {
                            detail:{
                                x: mouseRect.x/rect.width,
                                y: mouseRect.y/rect.height
                            }
                        }));
                    }
            
                    function handlerDown($event)
                    {
                        $event.preventDefault();
                        document.addEventListener("mousemove", handlerMove);
                        document.addEventListener("mouseup", handlerUp);
            
                        document.addEventListener("touchmove", handlerMove);
                        document.addEventListener("touchend", handlerUp);
            
                        handlerMove($event);
                        
                        inElement.dispatchEvent(new CustomEvent("dragstart"));
                    }
            
                    function handlerUp($event)
                    {
                        document.removeEventListener("mousemove", handlerMove);
                        document.removeEventListener("mouseup", handlerUp);
            
                        document.removeEventListener("touchmove", handlerMove);
                        document.removeEventListener("touchend", handlerUp);
            
                        inElement.dispatchEvent(new CustomEvent("dragstop"));
                    }
                    
                    inElement.addEventListener("mousedown", handlerDown);
                    inElement.addEventListener("touchstart", handlerDown);
                }
            });
        </script>
        
        <!-- tone generator -->
        <script>
            var Tone = {};
            Tone.Context = new (window.AudioContext || window.webkitAudioContext)();
            Tone.Time = {
                Timer:0,
                Counter:0,
                Update: function()
                {
                    switch(Tone.Time.Counter)
                    {
                        case 0:
                            Tone.GainBeep.gain.value = 1;
                            break;
                        case 1:
                            Tone.GainBeep.gain.value = 0;
                            break;
                        default:
                            Tone.Time.Counter = -1;
                    }
                    Tone.Time.Counter++;
                },
                Reset: function()
                {
                    Tone.GainBeep.gain.value = 0;
                    Tone.Time.Counter = 0;
                },
                Start: function()
                {
                    Tone.Time.Reset();
                    Tone.Time.Timer = setInterval(Tone.Time.Update, 100);
                },
                Stop: function()
                {
                    clearInterval(Tone.Time.Timer);
                    Tone.Time.Reset();
                }
            };

            Tone.Setup = function(inFrequency, inPan, inDB)
            {
                Tone.GainBeep = Tone.Context.createGain();
                Tone.GainBeep.gain.value = 0;
                Tone.GainDB = Tone.Context.createGain();
                Tone.Panner = Tone.Context.createStereoPanner();
                Tone.Oscillator = Tone.Context.createOscillator();
                Tone.Oscillator.start();

                Tone.Oscillator.connect(Tone.GainDB);
                Tone.GainDB.connect(Tone.GainBeep);
                Tone.GainBeep.connect(Tone.Panner);
                Tone.Panner.connect(Tone.Context.destination);

                Tone.Oscillator.frequency.value = inFrequency;
                Tone.Panner.pan.value = inPan;
                Tone.Fade(inDB);
            };
            Tone.Fade = function(inDB)
            {
                Tone.GainDB.gain.value = inDB*0.01;
            };
        </script>
       
       <!-- tone/slider component -->
       <script>
            Vue.component('tone', {
                props:['value'],
                data: function()
                {
                    return {
                        pos:this.value
                    }  
                },
                mounted: function()
                {
                    var inElement = this.$el;
                    var context = this;
                    
                    console.log(context);
                    
                    //this.pos = this.value;
                    
                    function clip(inMin, inAmount, inMax)
                    {
                        if(inAmount < inMin)
                        {
                            return inMin;
                        }
                        if(inAmount > inMax)
                        {
                            return inMax;
                        }
                        return inAmount;
                    }
                    
                    function handlerMove($event)
                    {
                        //coords of AABB within browser window
                        var rect = inElement.getBoundingClientRect();
                        var locX = $event.clientX || $event.touches[0].clientX;
                        var locY = $event.clientY || $event.touches[0].clientY;
        
                        //$event.client is the coords of the mouse within the browser window
                        var mouseRect = {
                            x:clip(0, locX - rect.left, rect.width),
                            y:clip(0, locY - rect.top, rect.height)
                        };
            
                        var mouseRelative = {
                            x:mouseRect.x/rect.width,
                            y:mouseRect.y/rect.height
                        };
                        
                        context.pos = mouseRelative.x;
                        
                        context.$emit('input', mouseRelative);
                    };
            
                    function handlerDown($event)
                    {
                        $event.preventDefault();
                        document.addEventListener("mousemove", handlerMove);
                        document.addEventListener("mouseup", handlerUp);
                        document.addEventListener("touchmove", handlerMove);
                        document.addEventListener("touchend", handlerUp);
            
                        Tone.Setup(250, 0, 100);
                        Tone.Time.Start();
            
                        handlerMove($event);
                    };
            
                    function handlerUp($event)
                    {
                        document.removeEventListener("mousemove", handlerMove);
                        document.removeEventListener("mouseup", handlerUp);
                        document.removeEventListener("touchmove", handlerMove);
                        document.removeEventListener("touchend", handlerUp);
                        
                        Tone.Time.Stop();
                    };
                    
                    inElement.addEventListener("mousedown", handlerDown);
                    inElement.addEventListener("touchstart", handlerDown);
                },
                computed:{
                    style:function()
                    {
                        return {
                            height: (this.pos*100)+"%",
                            width:"100%",
                            background:"#F00"
                        };
                    }
                },
                template:'<div style="width:500px; height:2000px; background:#FA0;"><div v-bind:style="style"></div></div>'
            });
        </script>
        
        <!-- slider component -->
        <script>
            Vue.component('slider', {
                props:['value'],
                mounted:function()
                {
                  console.log(this.$el);  
                },
                methods:{
                    HandlerStart: function()
                    {
                        console.log("starting audio");
                        this.$emit('test', {yep:true});
                    }
                },
                template:"#TemplateSlider"
            });
        </script>
        <script type="text/x-template" id="TemplateSlider">
            <div class="Slider">
                <div class="Data">{{value}}</div>
                <div class="Area"
                    v-slider
                    v-on:drag="$emit('drag', $event)"
                    v-on:dragstart="$emit('dragstart', $event)"
                    v-on:dragstart="HandlerStart"
                    v-on:dragstop="$emit('dragstop', $event)"
                    style="width:300px; background:#fff;"
                >
                    <div class="Bar" style="height:50px; background:#000;" v-bind:style="{width:value*100 + '%'}"></div>
                </div>
            </div>
        </script>
        
        <!-- vue app -->
        <script>
            var App = new Vue({
                el:"#App",
                data:{
                    Value:0.1,
                    Rect:{x:0.5, y:0.5}
                },
                methods:{
                    HandlerSlide: function(inEvent)
                    {
                        this.Rect.x = inEvent.detail.x;
                    },
                    HandlerTest: function(inEvent)
                    {
                        console.log(inEvent);
                    }
                }
            });
        </script>
    </body>
</html>