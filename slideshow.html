<!DOCTYPE html>
<html>
    <head>
        
        <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
        
        <!-- Tone -->
        <script>
var Tone = {};
Tone.Beep = {
    Timer:0,
    Counter:0,
    Pattern:[0, 1, 0, 1, 0, 1, 0, 0],
    Quit:true,
    Done:true,
    Update: function()
    {
        if(Tone.Beep.Counter >= Tone.Beep.Pattern.length)
        {
            if(Tone.Beep.Quit)
            {
                clearInterval(Tone.Beep.Timer);
                Tone.Change(Tone.GainBeep.gain, 0);
                Tone.Context.close().then(function(){
                    
                    Tone.Beep.Done = true;
                });
            }
            Tone.Beep.Counter = 0;
        }
        Tone.Change(Tone.GainBeep.gain, Tone.Beep.Pattern[Tone.Beep.Counter]);
        Tone.Beep.Counter++;
    },
    Start: function()
    {
        if(!Tone.Beep.Quit)
            return;
            
        if(Tone.Beep.Done)
        {
            Tone.Init();
        }
        
        Tone.Beep.Done = false;
        Tone.Beep.Quit = false;
        Tone.Beep.Counter = 0;
        clearInterval(Tone.Beep.Timer);
        Tone.Beep.Timer = setInterval(Tone.Beep.Update, 120);
        Tone.Beep.Update();
    },
    Stop: function()
    {
        Tone.Beep.Quit = true;
    }
};
Tone.Init = function()
{
    Tone.Context = new (window.AudioContext || window.webkitAudioContext)();
    Tone.GainBeep = Tone.Context.createGain();
    Tone.GainDB = Tone.Context.createGain();
    Tone.Panner = Tone.Context.createStereoPanner();
    Tone.Oscillator = Tone.Context.createOscillator();
    Tone.Oscillator.start();

    Tone.Oscillator.connect(Tone.GainDB);
    Tone.GainDB.connect(Tone.GainBeep);
    Tone.GainDB.gain.setValueAtTime(0, Tone.Context.currentTime);
    Tone.GainBeep.connect(Tone.Panner);
    Tone.GainBeep.gain.setValueAtTime(0, Tone.Context.currentTime);
    Tone.Panner.connect(Tone.Context.destination);
};
Tone.Change = function(inAdjustable, inValue)
{
    inAdjustable.linearRampToValueAtTime(inValue, Tone.Context.currentTime+0.008);
}
Tone.Pan = function(inValue)
{
    Tone.Change(Tone.Panner.pan, inValue);
};
Tone.Volume = function(inValue)
{
    Tone.Change(Tone.GainDB.gain, inValue);
};
Tone.Frequency = function(inValue)
{
    Tone.Change(Tone.Oscillator.frequency, inValue);
};
Tone.Init();
        </script>
        
        <!-- CustomEvent polyfill -->
        <script>
(function ()
{
    if ( typeof window.CustomEvent === "function" ) return false;
    function CustomEvent ( event, params )
    {
        params = params || { bubbles: false, cancelable: false, detail: undefined };
        var evt = document.createEvent( 'CustomEvent' );
        evt.initCustomEvent( event, params.bubbles, params.cancelable, params.detail );
        return evt;
    }
    CustomEvent.prototype = window.Event.prototype;
    window.CustomEvent = CustomEvent;
})();
        </script>
        
        <!-- Lerp -->
        <script>
        var Lerp = {
            Get: function(inMin, inAmount, inMax)
            {
                return (inAmount - inMin)/(inMax - inMin);
            },
            Set: function(inMin, inAmount, inMax)
            {
                return inMin + inAmount*(inMax - inMin);
            },
            Clip: function(inMin, inAmount, inMax)
            {
                if(inAmount < inMin)
                {
                    return inMin;
                }
                if(inAmount > inMax)
                {
                    return inMax;
                }
                return inAmount;
            }
        };
        </script>
        
        <!-- Drag -->
        <script>
var Drag = {};
Drag.Setup = function(inElement)
{
    var HandlerMove = function(inEvent)
    {
        //coords of AABB within browser window
        var rect = inElement.getBoundingClientRect();
        var locX = inEvent.clientX || inEvent.touches[0].clientX;
        var locY = inEvent.clientY || inEvent.touches[0].clientY;
    
        //inEvent.client is the coords of the mouse within the browser window
        var mouse = {
            x:Lerp.Clip(0, locX - rect.left, rect.width)/rect.width,
            y:Lerp.Clip(0, locY - rect.top, rect.height)/rect.height
        };
        
        var event = new CustomEvent("drag", {bubbles:true, detail:mouse});
        inElement.dispatchEvent( event );
        
        return mouse;
    };
    var HandlerDown = function(inEvent)
    {
        inEvent.preventDefault();
        document.addEventListener("mousemove", HandlerMove);
        document.addEventListener("mouseup", HandlerUp);
        document.addEventListener("touchmove", HandlerMove);
        document.addEventListener("touchend", HandlerUp);
        document.addEventListener("mouseleave", HandlerUp);
    
        var event = new CustomEvent("dragstart", {bubbles:true});
        inElement.dispatchEvent( event );
        HandlerMove(inEvent);
    };
    var HandlerUp = function(inEvent)
    {
        document.removeEventListener("mousemove", HandlerMove);
        document.removeEventListener("mouseup", HandlerUp);
        document.removeEventListener("touchmove", HandlerMove);
        document.removeEventListener("touchend", HandlerUp);
        document.removeEventListener("mouseleave", HandlerUp);
        
        var event = new CustomEvent("dragstop", {bubbles:true});
        inElement.dispatchEvent( event );
    };
    
    inElement.addEventListener("mousedown", HandlerDown);
    inElement.addEventListener("touchstart", HandlerDown);
};
        </script>
        
        <link rel="stylesheet" type="text/css" href="styles.css">
        
    </head>
    <body>
        
        <div id="App">
            <Slideshow>
                <template slot-scope="Slideshow">
                    <Slide v-bind:active="Slideshow.SlidesState[0]" v-bind:backward="Slideshow.SlidesBackward">
                        <h2>Part One</h2>
                        <p>Please remove ear protection and make sure headphones fit correctly</p>
                        <Test-Set>
                            <div slot-scope="TestSet">
                                <button v-on:click="Slideshow.SlidesPrevious">Back</button>
                                <button v-on:click="TestSet.Reset"    v-show="TestSet.Started">Reset</button>
                                <button v-on:click="Slideshow.SlidesNext" v-show="TestSet.Done">Next</button>
                            </div>
                        </Test-Set>
                    </Slide> 
                    <Slide v-bind:active="Slideshow.SlidesState[1]" v-bind:backward="Slideshow.SlidesBackward">
                        <h2>Part Two</h2>
                        <p>Please insert ear protection and make sure headphones fit correctly</p>
                        <Test-Set>
                            <div slot-scope="TestSet">
                                <button v-on:click="Slideshow.SlidesPrevious">Back</button>
                                <button v-on:click="TestSet.Reset"    v-show="TestSet.Started">Reset</button>
                                <button v-on:click="Slideshow.SlidesNext" v-show="TestSet.Done">Next</button>
                            </div>
                        </Test-Set>
                    </Slide> 
                    <Slide v-bind:active="Slideshow.SlidesState[2]" v-bind:backward="Slideshow.SlidesBackward">
                        <h2>Part Three</h2>
                        <p>Please insert ear protection and make sure headphones fit correctly</p>
                    </Slide>
                </template>
            </Slideshow>
        </div>

        <!-- slide component -->
        <script>
            Vue.component("Slide", {
                props:["active", "backward"],
                data:function()
                {
                    return {
                        CSS:""
                   };
                },
                watch:{
                   active:function(inNew, inOld)
                   {
                       var prefix, suffix;
                       
                       if(inNew){prefix = "Active";}
                       else{prefix = "Inactive";}
                       
                       if(this.backward){suffix = "Backward";}
                       else{suffix = "Forward";}
                       
                       this.CSS = prefix+" "+suffix;
                   }
                },
                mounted:function()
                {
                },
               template:"#TemplateSlide"
            });
        </script>
        <script type="x-template" id="TemplateSlide">
            <div class="Band Slide" v-bind:class="CSS">
                <div class="Center">
                    <div class="Pad">
                        <slot></slot>
                    </div>
                </div>
            </div>
        </script>
        
        <!-- slideshow component -->
        <script>
            Vue.component("Slideshow", {
                data: function()
                {
                    return{
                        SlidesState:[],
                        SlidesBackward:true,
                        SlidesActive:0
                    };
                },
                methods:{
                    SlidesChange:function(inIndex, inBackward)
                    {
                        if(inIndex == this.SlidesActive){return;}
                        
                        this.SlidesBackward = inBackward;
                        
                        Vue.set(this.SlidesState, this.SlidesActive, false);
                        this.SlidesActive = inIndex;
                        Vue.set(this.SlidesState, this.SlidesActive, true);
                    },
                    SlidesPrevious:function(inBackward)
                    {
                        var index;
                        if(this.SlidesActive == 0)
                        {
                            index = this.SlidesState.length-1;
                        }
                        else
                        {
                            index = this.SlidesActive-1;
                        }
                        this.SlidesChange(index, inBackward);
                    },
                    SlidesNext:function(inBackward)
                    {
                        var index;
                        if(this.SlidesActive == this.SlidesState.length-1)
                        {
                            index = 0;
                        }
                        else
                        {
                            index = this.SlidesActive+1;
                        }
                        this.SlidesChange(index, inBackward);
                    }
                },
                mounted: function()
                {
                    var i;
                    for(i=0; i<this.$children.length; i++)
                    {
                        var child = this.$children[i];
                        if(child.$options._componentTag == "slide")
                        {
                            this.SlidesState.push(false);
                        }
                    }
                    Vue.set(this.SlidesState, this.SlidesActive, true);
                },
                template:"#TemplateSlideshow"
            })
        </script>
        <script type="x-template" id="TemplateSlideshow">
            <div class="Slideshow">
                <slot v-bind="this">
                </slot>
            </div>
        </script>

        <!-- slider component -->
        <script>
            Vue.directive("Drag", {
                bind:function(inElement)
                {
                    Drag.Setup(inElement);
                }
            })
        </script>
        <script>
            Vue.component("Slider", {
                props:{
                    Steps:{
                        type:Number,
                        default:10
                    },
                    Min:{
                        type:Number,
                        default:0
                    },
                    Max:{
                        type:Number,
                        default:0.8
                    },
                    Hz:{
                        type:Number,
                        default:440
                    }
                },
                data:function()
                {
                    return{
                        Stepped:0,
                        Percent:0,
                        Mapped:0,
                        Adjusted:false,
                        Adjusting:false
                    };
                },
                methods:{
                    HandlerDrag:function(inEvent)
                    {
                      this.Update(1-inEvent.detail.y);
                    },
                    HandlerDragStart:function()
                    {
                        this.Adjusting = true;
                        this.Adjusted = true;
                        Tone.Frequency(this.Hz);
                        console.log("Hz:", this.Hz);
                        Tone.Beep.Start();
                    },
                    HandlerDragStop:function()
                    {
                        this.Adjusting = false;
                        Tone.Beep.Stop();
                        this.$emit("done", {});
                    },
                    Update:function(inValue)
                    {
                        this.Stepped = Math.floor(inValue*this.Steps)/this.Steps;
                        this.Percent = this.Stepped*100;
                        this.Mapped = Lerp.Set(this.Min, this.Stepped, this.Max);
                        Tone.Volume(this.Mapped);
                    },
                    Reset:function()
                    {
                        this.Update(0.8);
                        this.Adjusted = false;
                        this.Adjusting = false;
                    }
                },
                mounted:function(){
                    this.Reset();
                },
                template:"#TemplateSlider"
            })
        </script>
        <script type="x-template" id="TemplateSlider">
            <div class="Slider"
                v-bind:class="{Adjusting: Adjusting, Adjusted: Adjusted}"
                v-drag
                v-on:drag="HandlerDrag"
                v-on:dragstart="HandlerDragStart"
                v-on:dragstop="HandlerDragStop">
                <div class="Bar" v-bind:style="{height:Percent+'%'}">
                </div>
            </div>
        </script>

        <!-- Test set -->
        <script>
            Vue.component("TestSet", {
                data:function()
                {
                    return{
                        Done:false,
                        Started:false,
                        HighLeft:  {Min:0,   Max:0.1, Steps:20, Hz:4000, Pan:-1},
                        HighRight: {Min:0,   Max:0.1, Steps:20, Hz:4000, Pan:+1},
                        LowLeft:   {Min:0.1, Max:1,   Steps:20, Hz:250,  Pan:-1},
                        LowRight:  {Min:0.1, Max:1,   Steps:20, Hz:250,  Pan:+1}
                    };
                },
                methods:{
                    IsDone:function()
                    {
                        var i;
                        for(i=0; i<this.$children.length; i++)
                        {
                            if(!this.$children[i].$data.Adjusted)
                            {
                                return false;
                            }
                        }
                        return true;
                    },
                    IsStarted:function()
                    {
                        var i;
                        for(i=0; i<this.$children.length; i++)
                        {
                            if(this.$children[i].$data.Adjusted)
                            {
                                return true;
                            }
                        }
                        return false;
                    },
                    Update:function()
                    {
                        console.log("Test update")
                        this.Done = this.IsDone();
                        this.Started = this.IsStarted();
                    },
                    Reset:function()
                    {
                        var i;
                        for(i=0; i<this.$children.length; i++)
                        {
                            this.$children[i].Reset();
                        }
                        this.Done = false;
                        this.Started = false;
                    }
                },
                mounted:function()
                {
                },
                template:"#TemplateTestSet"
            })
        </script>
        <script type="x-template" id="TemplateTestSet">
            <div class="Test">
                <slot v-bind="this">
                    <button v-on:click="$root.SlidesPrevious">Back Default</button>
                    <button v-on:click="Reset"    v-show="Started">Reset Default</button>
                    <button v-on:click="$root.SlidesNext" v-show="Done">Next Default</button>
                </slot>
                <Slider v-bind="HighLeft"  v-on:done="Update"></Slider>
                <Slider v-bind="HighRight" v-on:done="Update"></Slider>
                <Slider v-bind="LowLeft"   v-on:done="Update"></Slider>
                <Slider v-bind="LowRight"  v-on:done="Update"></Slider>
            </div>
        </script>

        <!-- vue app -->
        <script>
            var App = new Vue({
                el:"#App",
                data:{
                    TestResultsNormal:    {Started:false, Done:false, Output:[]},
                    TestResultsProtected: {Started:false, Done:false, Output:[]},
                }
            });
        </script>
        
    </body>
</html>